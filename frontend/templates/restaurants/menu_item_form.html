{% extends "base.html" %}

{% block title %}{{ form_type }} - Menu Management{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h2>{{ form_type }}</h2>
            <p class="text-muted">Create or update menu items for your restaurant.</p>
        </div>
        <div class="col-auto">
            <a href="{% url 'webapp:menu_management' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Menu Management
            </a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <form id="menu-item-form" class="needs-validation" novalidate enctype="multipart/form-data">
                <input type="hidden" id="itemId" value="{{ item_id }}">
                <input type="hidden" id="categoryIdForNewItem" value="{{ category_id }}">

                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="itemName" class="form-label">Item Name</label>
                            <input type="text" class="form-control" id="itemName" name="name" required>
                            <div class="invalid-feedback">Please provide an item name.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="itemDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="itemDescription" name="description" rows="3"></textarea>
                            <div class="form-text">Describe your item to entice customers.</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="itemPrice" class="form-label">Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" step="0.01" min="0.01" class="form-control" id="itemPrice" name="price" required>
                                    <div class="invalid-feedback">Please provide a valid price.</div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="itemCategory" class="form-label">Category</label>
                                <select class="form-select" id="itemCategory" name="category" required>
                                    <option value="">Select a category...</option>
                                    <!-- Categories will be loaded here by JavaScript -->
                                </select>
                                <div class="invalid-feedback">Please select a category.</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="itemIngredients" class="form-label">Ingredients</label>
                            <textarea class="form-control" id="itemIngredients" name="ingredients" rows="2"></textarea>
                            <div class="form-text">List the main ingredients used in this item.</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="itemAllergens" class="form-label">Allergens</label>
                                <input type="text" class="form-control" id="itemAllergens" name="allergens">
                                <div class="form-text">E.g., nuts, dairy, gluten, etc.</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="itemCalories" class="form-label">Calories</label>
                                <input type="number" class="form-control" id="itemCalories" name="calories" min="0">
                                <div class="form-text">Optional calorie information.</div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="itemPreparationTime" class="form-label">Preparation Time (minutes)</label>
                            <input type="number" class="form-control" id="itemPreparationTime" name="preparation_time" min="1">
                            <div class="form-text">Estimated time to prepare this item.</div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-4">
                            <label for="itemImage" class="form-label">Item Image</label>
                            <input type="file" class="form-control" id="itemImage" name="image" accept="image/*">
                            <div class="form-text">Recommended size: 800x600 pixels. Max size: 5MB.</div>
                            <div id="current-item-image-container" class="mt-2 text-center">
                                <img id="current-item-image" src="#" alt="Current Item Image" class="img-thumbnail" style="max-height: 200px; display: none;">
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header">Item Status</div>
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="itemIsAvailable" name="is_available" checked>
                                    <label class="form-check-label" for="itemIsAvailable">
                                        Item is available for ordering
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="itemIsFeatured" name="is_featured">
                                    <label class="form-check-label" for="itemIsFeatured">
                                        Feature this item (highlighted in menu)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="form-errors" class="alert alert-danger d-none mb-3"></div>
                
                <div class="d-flex justify-content-between mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Menu Item
                    </button>
                    <a href="{% url 'webapp:menu_management' %}" class="btn btn-outline-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const menuItemForm = document.getElementById('menu-item-form');
    const itemIdInput = document.getElementById('itemId');
    const categoryIdForNewItemInput = document.getElementById('categoryIdForNewItem');
    
    const itemNameInput = document.getElementById('itemName');
    const itemDescriptionInput = document.getElementById('itemDescription');
    const itemPriceInput = document.getElementById('itemPrice');
    const itemCategorySelect = document.getElementById('itemCategory');
    const itemIngredientsInput = document.getElementById('itemIngredients');
    const itemAllergensInput = document.getElementById('itemAllergens');
    const itemCaloriesInput = document.getElementById('itemCalories');
    const itemPreparationTimeInput = document.getElementById('itemPreparationTime');
    const itemImageInput = document.getElementById('itemImage');
    const currentItemImage = document.getElementById('current-item-image');
    const itemIsAvailableCheckbox = document.getElementById('itemIsAvailable');
    const itemIsFeaturedCheckbox = document.getElementById('itemIsFeatured');
    const formErrorsEl = document.getElementById('form-errors');
    
    const accessToken = localStorage.getItem('accessToken');
    const isEditMode = itemIdInput.value !== '' && itemIdInput.value !== 'None';
    let myRestaurantId = null;

    if (!accessToken) {
        window.location.href = "{% url 'webapp:login' %}?next=" + window.location.pathname;
        return;
    }

    function fetchAPI(endpoint, method = 'GET', body = null, isFormData = false) {
        const headers = {};
        if (!isFormData) {
            headers['Content-Type'] = 'application/json';
        }
        headers['Authorization'] = `Bearer ${accessToken}`;
        
        const config = { method: method, headers: headers };
        if (body) config.body = body;
        
        return fetch(endpoint, config).then(response => {
            if (!response.ok) return response.json().then(err => { throw err; });
            if (response.status === 204 || (response.ok && response.headers.get("Content-Length") === "0" && method !== 'GET')) return null; 
            return response.json();
        });
    }

    function showError(message) {
        formErrorsEl.innerHTML = message;
        formErrorsEl.classList.remove('d-none');
    }

    function hideError() {
        formErrorsEl.innerHTML = '';
        formErrorsEl.classList.add('d-none');
    }

    function loadCategories(selectedCategoryId = null) {
        if (!myRestaurantId) return;
        
        fetchAPI(`/api/restaurants/categories/?restaurant=${myRestaurantId}`)
            .then(data => {
                const categories = data.results || data;
                itemCategorySelect.innerHTML = '<option value="">Select a category...</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    if (selectedCategoryId && category.id === selectedCategoryId) {
                        option.selected = true;
                    }
                    itemCategorySelect.appendChild(option);
                });
                
                // If creating new item under a specific category
                const preselectCategoryId = categoryIdForNewItemInput.value;
                if (preselectCategoryId && preselectCategoryId !== 'None' && !isEditMode) {
                    itemCategorySelect.value = preselectCategoryId;
                }
            })
            .catch(error => {
                console.error('Error loading categories:', error);
                showError('Failed to load categories. Please refresh the page and try again.');
            });
    }

    // Preview image when selected
    itemImageInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                currentItemImage.src = e.target.result;
                currentItemImage.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    // Get Restaurant ID first, then load categories and item data if editing
    fetchAPI('/api/restaurants/list/mine/')
        .then(restaurantData => {
            if (restaurantData && restaurantData.id) {
                myRestaurantId = restaurantData.id;
                loadCategories();
                if (isEditMode) {
                    loadMenuItemData(itemIdInput.value);
                }
            } else {
                throw new Error("Could not identify your restaurant.");
            }
        })
        .catch(error => {
            console.error("Error fetching restaurant ID:", error);
            showError("Could not verify your restaurant. Please try again. " + (error.detail || error.message));
            menuItemForm.innerHTML = '<p class="text-danger">Cannot load form.</p>';
        });

    function loadMenuItemData(itemId) {
        fetchAPI(`/api/restaurants/menu-items/${itemId}/`)
            .then(data => {
                itemNameInput.value = data.name || '';
                itemDescriptionInput.value = data.description || '';
                itemPriceInput.value = data.price || '';
                itemIngredientsInput.value = data.ingredients || '';
                itemAllergensInput.value = data.allergens || '';
                itemCaloriesInput.value = data.calories || '';
                itemPreparationTimeInput.value = data.preparation_time || '';
                itemIsAvailableCheckbox.checked = data.is_available !== undefined ? data.is_available : true;
                itemIsFeaturedCheckbox.checked = data.is_featured || false;
                
                if (data.category) {
                    const categoryIdToSelect = typeof data.category === 'object' ? data.category.id : data.category;
                    if (itemCategorySelect.options.length > 1) {
                        itemCategorySelect.value = categoryIdToSelect;
                    } else {
                        loadCategories(categoryIdToSelect);
                    }
                }

                if (data.image) {
                    currentItemImage.src = data.image;
                    currentItemImage.style.display = 'block';
                } else {
                    currentItemImage.style.display = 'none';
                }
                
                // Ensure restaurant ID matches
                if (data.restaurant !== myRestaurantId) {
                    showError("Error: This menu item does not belong to your restaurant.");
                    setTimeout(() => {
                        window.location.href = "{% url 'webapp:menu_management' %}";
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error loading menu item data:', error);
                showError('Failed to load menu item data. ' + (error.detail || JSON.stringify(error)));
            });
    }

    menuItemForm.addEventListener('submit', function(event) {
        event.preventDefault();
        hideError();
        
        // Form validation
        if (!menuItemForm.checkValidity()) {
            event.stopPropagation();
            menuItemForm.classList.add('was-validated');
            return;
        }

        if (!myRestaurantId) {
            showError("Your restaurant information is not available. Cannot save item.");
            return;
        }

        const formData = new FormData(menuItemForm);
        
        // Ensure boolean fields are properly set
        if (!formData.has('is_available')) formData.append('is_available', false);
        if (!formData.has('is_featured')) formData.append('is_featured', false);
        
        // Add restaurant ID
        formData.append('restaurant', myRestaurantId);

        let url = '/api/restaurants/menu-items/';
        let method = 'POST';

        if (isEditMode) {
            url += `${itemIdInput.value}/`;
            method = 'PUT';
        }

        fetchAPI(url, method, formData, true)
            .then(data => {
                window.location.href = "{% url 'webapp:menu_management' %}?success=" + encodeURIComponent(`Menu item ${isEditMode ? 'updated' : 'created'} successfully!`);
            })
            .catch(errorData => {
                console.error(`Error ${isEditMode ? 'updating' : 'creating'} menu item:`, errorData);
                
                let errorMessages = [];
                
                function formatFieldName(fieldName) {
                    const words = fieldName.replace(/_/g, ' ').split(' ');
                    return words.map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                }

                if (typeof errorData === 'object' && errorData !== null) {
                    for (const key in errorData) {
                        const formattedKey = formatFieldName(key);
                        if (Array.isArray(errorData[key])) {
                            errorMessages.push(`<strong>${formattedKey}:</strong> ${errorData[key].join(', ')}`);
                        } else if (typeof errorData[key] === 'string') {
                            errorMessages.push(`<strong>${formattedKey}:</strong> ${errorData[key]}`);
                        } else if (typeof errorData[key] === 'object' && errorData[key] !== null) {
                            for (const subKey in errorData[key]) {
                                const formattedSubKey = formatFieldName(subKey);
                                errorMessages.push(`<strong>${formattedKey} - ${formattedSubKey}:</strong> ${errorData[key][subKey].join(', ')}`);
                            }
                        }
                    }
                } else if (typeof errorData === 'string') {
                    errorMessages.push(errorData);
                }

                if (errorMessages.length === 0) {
                    errorMessages.push('An unknown error occurred. Please check the console.');
                }
                
                showError(`<p>Failed to ${isEditMode ? 'update' : 'create'} menu item:</p><ul><li>${errorMessages.join('</li><li>')}</li></ul>`);
            });
    });
});
</script>
{% endblock %}