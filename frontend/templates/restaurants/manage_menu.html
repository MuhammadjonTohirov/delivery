{% extends "base.html" %}

{% block title %}Manage Menu - Delivery Platform{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h2>Manage Menu</h2>
            <p class="text-muted">Organize your menu categories and items to showcase your restaurant's offerings.</p>
        </div>
        <div class="col-auto">
            <a href="{% url 'webapp:category_form' %}" class="btn btn-success">
                <i class="fas fa-plus"></i> Add New Category
            </a>
        </div>
    </div>

    <!-- Success message -->
    <div id="success-alert" class="alert alert-success alert-dismissible fade show d-none" role="alert">
        <span id="success-message"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Menu management container -->
    <div id="menu-management-container">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2" id="loading-menu-data">Loading menu data...</p>
        </div>
    </div>

    <!-- Empty state -->
    <div id="empty-menu-state" class="text-center py-5 d-none">
        <div class="mb-4">
            <i class="fas fa-utensils fa-4x text-muted"></i>
        </div>
        <h4>No Menu Categories Yet</h4>
        <p class="text-muted">Start by adding a category to organize your menu items.</p>
        <a href="{% url 'webapp:category_form' %}" class="btn btn-primary mt-2">
            <i class="fas fa-plus"></i> Create First Category
        </a>
    </div>

    <!-- Category reorder modal -->
    <div class="modal fade" id="reorderCategoriesModal" tabindex="-1" aria-labelledby="reorderCategoriesModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reorderCategoriesModalLabel">Reorder Categories</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Drag and drop categories to change their display order.</p>
                    <ul id="sortable-categories" class="list-group">
                        <!-- Categories will be loaded here -->
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-category-order">Save Order</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const menuManagementContainer = document.getElementById('menu-management-container');
    const loadingMenuMsg = document.getElementById('loading-menu-data');
    const emptyMenuState = document.getElementById('empty-menu-state');
    const successAlert = document.getElementById('success-alert');
    const successMessage = document.getElementById('success-message');
    const sortableCategoriesList = document.getElementById('sortable-categories');
    const saveCategoryOrderBtn = document.getElementById('save-category-order');
    
    const accessToken = localStorage.getItem('accessToken');
    let myRestaurantId = null;
    let allCategories = [];

    // Check for success message in URL
    const urlParams = new URLSearchParams(window.location.search);
    const successMsg = urlParams.get('success');
    if (successMsg) {
        successMessage.textContent = successMsg;
        successAlert.classList.remove('d-none');
        // Remove the success parameter from URL
        window.history.replaceState({}, document.title, window.location.pathname);
    }

    if (!accessToken) {
        window.location.href = "{% url 'webapp:login' %}?next=" + window.location.pathname;
        return;
    }

    function fetchAPI(endpoint, method = 'GET', body = null) {
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        };
        const config = { method: method, headers: headers };
        if (body) config.body = JSON.stringify(body);
        
        return fetch(endpoint, config).then(response => {
            if (response.status === 204) return null; // Handle 204 No Content for DELETE
            if (!response.ok) return response.json().then(err => { throw err; });
            return response.json();
        });
    }

    // Format price with 2 decimal places
    function formatPrice(price) {
        return parseFloat(price).toFixed(2);
    }

    // Show confirmation dialog
    function confirmAction(message) {
        return confirm(message);
    }

    // Show toast notification
    function showToast(message, type = 'success') {
        successMessage.textContent = message;
        successAlert.classList.remove('d-none', 'alert-success', 'alert-danger');
        successAlert.classList.add(`alert-${type}`);
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            successAlert.classList.add('d-none');
        }, 5000);
    }

    // Delete category
    function deleteCategory(categoryId, categoryName) {
        if (confirmAction(`Are you sure you want to delete the category "${categoryName}" and all its items?`)) {
            fetchAPI(`/api/restaurants/categories/${categoryId}/`, 'DELETE')
                .then(() => {
                    showToast(`Category "${categoryName}" deleted successfully.`);
                    loadMenuData();
                })
                .catch(error => {
                    console.error('Error deleting category:', error);
                    showToast(`Failed to delete category: ${error.detail || JSON.stringify(error)}`, 'danger');
                });
        }
    }

    // Delete menu item
    function deleteMenuItem(itemId, itemName) {
        if (confirmAction(`Are you sure you want to delete the menu item "${itemName}"?`)) {
            fetchAPI(`/api/restaurants/menu-items/${itemId}/`, 'DELETE')
                .then(() => {
                    showToast(`Menu item "${itemName}" deleted successfully.`);
                    loadMenuData();
                })
                .catch(error => {
                    console.error('Error deleting menu item:', error);
                    showToast(`Failed to delete menu item: ${error.detail || JSON.stringify(error)}`, 'danger');
                });
        }
    }

    // Toggle item availability
    function toggleItemAvailability(itemId, itemName, currentStatus) {
        const newStatus = !currentStatus;
        fetchAPI(`/api/restaurants/menu-items/${itemId}/`, 'PATCH', {
            is_available: newStatus
        })
        .then(() => {
            showToast(`"${itemName}" is now ${newStatus ? 'available' : 'unavailable'}.`);
            loadMenuData();
        })
        .catch(error => {
            console.error('Error updating item availability:', error);
            showToast(`Failed to update item availability: ${error.detail || JSON.stringify(error)}`, 'danger');
        });
    }

    // Toggle item featured status
    function toggleItemFeatured(itemId, itemName, currentStatus) {
        const newStatus = !currentStatus;
        fetchAPI(`/api/restaurants/menu-items/${itemId}/`, 'PATCH', {
            is_featured: newStatus
        })
        .then(() => {
            showToast(`"${itemName}" is ${newStatus ? 'now featured' : 'no longer featured'}.`);
            loadMenuData();
        })
        .catch(error => {
            console.error('Error updating item featured status:', error);
            showToast(`Failed to update featured status: ${error.detail || JSON.stringify(error)}`, 'danger');
        });
    }

    // Toggle category active status
    function toggleCategoryActive(categoryId, categoryName, currentStatus) {
        const newStatus = !currentStatus;
        fetchAPI(`/api/restaurants/categories/${categoryId}/`, 'PATCH', {
            is_active: newStatus
        })
        .then(() => {
            showToast(`Category "${categoryName}" is now ${newStatus ? 'active' : 'inactive'}.`);
            loadMenuData();
        })
        .catch(error => {
            console.error('Error updating category status:', error);
            showToast(`Failed to update category status: ${error.detail || JSON.stringify(error)}`, 'danger');
        });
    }

    // Initialize category reordering
    function initCategoryReordering() {
        // Clear existing items
        sortableCategoriesList.innerHTML = '';
        
        // Add categories to the sortable list
        allCategories.forEach(category => {
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
            listItem.dataset.categoryId = category.id;
            listItem.dataset.order = category.order;
            listItem.innerHTML = `
                <div>
                    <i class="fas fa-grip-lines me-2"></i>
                    <span>${category.name}</span>
                </div>
                <span class="badge bg-secondary">Order: ${category.order}</span>
            `;
            sortableCategoriesList.appendChild(listItem);
        });
        
        // Make the list sortable
        // Note: In a real implementation, you would use a library like SortableJS
        // For this example, we'll just simulate the functionality
        
        // Save the new order
        saveCategoryOrderBtn.addEventListener('click', function() {
            const newOrder = Array.from(sortableCategoriesList.children).map((item, index) => {
                return {
                    id: item.dataset.categoryId,
                    order: index
                };
            });
            
            // Update each category with its new order
            Promise.all(newOrder.map(item => 
                fetchAPI(`/api/restaurants/categories/${item.id}/`, 'PATCH', { order: item.order })
            ))
            .then(() => {
                showToast('Category order updated successfully.');
                loadMenuData();
                // Close the modal
                bootstrap.Modal.getInstance(document.getElementById('reorderCategoriesModal')).hide();
            })
            .catch(error => {
                console.error('Error updating category order:', error);
                showToast('Failed to update category order.', 'danger');
            });
        });
    }

    function renderMenuManagement(categories) {
        // Hide loading indicator
        menuManagementContainer.innerHTML = '';
        
        // Store categories for reordering
        allCategories = categories;
        
        // Show empty state if no categories
        if (!categories || categories.length === 0) {
            emptyMenuState.classList.remove('d-none');
            menuManagementContainer.classList.add('d-none');
            return;
        }
        
        // Hide empty state and show menu container
        emptyMenuState.classList.add('d-none');
        menuManagementContainer.classList.remove('d-none');
        
        // Add reorder button
        const reorderBtn = document.createElement('div');
        reorderBtn.className = 'mb-4 text-end';
        reorderBtn.innerHTML = `
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#reorderCategoriesModal">
                <i class="fas fa-sort"></i> Reorder Categories
            </button>
        `;
        menuManagementContainer.appendChild(reorderBtn);
        
        // Render each category
        categories.forEach(category => {
            const categoryCard = document.createElement('div');
            categoryCard.className = 'card mb-4 shadow-sm';
            categoryCard.innerHTML = `
                <div class="card-header bg-${category.is_active ? 'light' : 'secondary text-white'}">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            ${category.name}
                            ${!category.is_active ? '<span class="badge bg-warning text-dark ms-2">Inactive</span>' : ''}
                            <small class="text-muted ms-2">(Order: ${category.order})</small>
                        </h5>
                        <div class="btn-group">
                            <a href="{% url 'webapp:menu_item_form' %}?category=${category.id}" class="btn btn-sm btn-success">
                                <i class="fas fa-plus"></i> Add Item
                            </a>
                            <a href="{% url 'webapp:category_form' %}?id=${category.id}" class="btn btn-sm btn-primary">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                            <button class="btn btn-sm btn-${category.is_active ? 'warning' : 'info'} toggle-category-active" data-category-id="${category.id}" data-category-name="${category.name}" data-is-active="${category.is_active}">
                                <i class="fas fa-${category.is_active ? 'eye-slash' : 'eye'}"></i> ${category.is_active ? 'Deactivate' : 'Activate'}
                            </button>
                            <button class="btn btn-sm btn-danger delete-category" data-category-id="${category.id}" data-category-name="${category.name}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    ${category.description ? `<p class="card-text">${category.description}</p>` : ''}
                    <div class="items-container">
                        ${category.items && category.items.length > 0 ? renderMenuItems(category.items) : '<p class="text-center text-muted py-3">No items in this category. Add your first item!</p>'}
                    </div>
                </div>
            `;
            menuManagementContainer.appendChild(categoryCard);
        });
        
        // Add event listeners
        addEventListeners();
    }
    
    function renderMenuItems(items) {
        let html = '<div class="row">';
        
        items.forEach(item => {
            html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 ${!item.is_available ? 'bg-light' : ''} ${item.is_featured ? 'border-warning' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title">
                                    ${item.name}
                                    ${item.is_featured ? '<span class="badge bg-warning text-dark ms-1"><i class="fas fa-star"></i> Featured</span>' : ''}
                                </h5>
                                <h6 class="text-primary">$${formatPrice(item.price)}</h6>
                            </div>
                            <p class="card-text small">${item.description || 'No description'}</p>
                            ${item.ingredients ? `<p class="card-text small"><strong>Ingredients:</strong> ${item.ingredients}</p>` : ''}
                            ${item.allergens ? `<p class="card-text small"><strong>Allergens:</strong> ${item.allergens}</p>` : ''}
                            ${item.preparation_time ? `<p class="card-text small"><strong>Prep time:</strong> ${item.preparation_time} min</p>` : ''}
                        </div>
                        ${item.image ? `
                            <img src="${item.image}" class="card-img-bottom" alt="${item.name}" style="height: 120px; object-fit: cover;">
                        ` : ''}
                        <div class="card-footer bg-transparent">
                            <div class="btn-group w-100">
                                <a href="{% url 'webapp:menu_item_form' %}?id=${item.id}" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                <button class="btn btn-sm btn-outline-${item.is_available ? 'warning' : 'success'} toggle-item-available" data-item-id="${item.id}" data-item-name="${item.name}" data-is-available="${item.is_available}">
                                    <i class="fas fa-${item.is_available ? 'ban' : 'check'}"></i> ${item.is_available ? 'Unavailable' : 'Available'}
                                </button>
                                <button class="btn btn-sm btn-outline-${item.is_featured ? 'secondary' : 'warning'} toggle-item-featured" data-item-id="${item.id}" data-item-name="${item.name}" data-is-featured="${item.is_featured}">
                                    <i class="fas fa-${item.is_featured ? 'star-half-alt' : 'star'}"></i> ${item.is_featured ? 'Unfeature' : 'Feature'}
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-item" data-item-id="${item.id}" data-item-name="${item.name}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        return html;
    }
    
    function addEventListeners() {
        // Delete category buttons
        document.querySelectorAll('.delete-category').forEach(button => {
            button.addEventListener('click', function() {
                const categoryId = this.dataset.categoryId;
                const categoryName = this.dataset.categoryName;
                deleteCategory(categoryId, categoryName);
            });
        });
        
        // Toggle category active status
        document.querySelectorAll('.toggle-category-active').forEach(button => {
            button.addEventListener('click', function() {
                const categoryId = this.dataset.categoryId;
                const categoryName = this.dataset.categoryName;
                const isActive = this.dataset.isActive === 'true';
                toggleCategoryActive(categoryId, categoryName, isActive);
            });
        });
        
        // Delete item buttons
        document.querySelectorAll('.delete-item').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                const itemName = this.dataset.itemName;
                deleteMenuItem(itemId, itemName);
            });
        });
        
        // Toggle item availability
        document.querySelectorAll('.toggle-item-available').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                const itemName = this.dataset.itemName;
                const isAvailable = this.dataset.isAvailable === 'true';
                toggleItemAvailability(itemId, itemName, isAvailable);
            });
        });
        
        // Toggle item featured status
        document.querySelectorAll('.toggle-item-featured').forEach(button => {
            button.addEventListener('click', function() {
                const itemId = this.dataset.itemId;
                const itemName = this.dataset.itemName;
                const isFeatured = this.dataset.isFeatured === 'true';
                toggleItemFeatured(itemId, itemName, isFeatured);
            });
        });
    }

    function loadMenuData() {
        // Show loading indicator
        menuManagementContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Loading menu data...</p>
            </div>
        `;
        
        // First, get the restaurant ID for the current owner
        fetchAPI('/api/restaurants/list/mine/')
            .then(restaurantData => {
                if (restaurantData && restaurantData.id) {
                    myRestaurantId = restaurantData.id;
                    // Then fetch categories with their items
                    return fetchAPI(`/api/restaurants/${myRestaurantId}/menu/`);
                } else {
                    throw new Error("Could not identify your restaurant.");
                }
            })
            .then(categoriesData => {
                renderMenuManagement(categoriesData);
                // Initialize category reordering
                initCategoryReordering();
            })
            .catch(error => {
                console.error('Error loading menu data:', error);
                menuManagementContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Error Loading Menu Data</h5>
                        <p>${error.detail || error.message || 'An unknown error occurred.'}</p>
                        <button class="btn btn-outline-danger mt-2" onclick="location.reload()">
                            <i class="fas fa-sync"></i> Retry
                        </button>
                    </div>
                `;
            });
    }

    // Initialize
    loadMenuData();
});
</script>
{% endblock %}