{% extends "base.html" %}

{% block title %}{{ form_type }} - Menu Management{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col">
            <h2>{{ form_type }}</h2>
            <p class="text-muted">Create or update menu categories to organize your menu items.</p>
        </div>
        <div class="col-auto">
            <a href="{% url 'webapp:menu_management' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Menu Management
            </a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <form id="category-form" class="needs-validation" novalidate>
                <input type="hidden" id="categoryId" value="{{ category_id }}">
                
                <div class="mb-3">
                    <label for="categoryName" class="form-label">Category Name</label>
                    <input type="text" class="form-control" id="categoryName" name="name" required>
                    <div class="invalid-feedback">Please provide a category name.</div>
                    <div class="form-text">Choose a clear, descriptive name for your menu category.</div>
                </div>
                
                <div class="mb-3">
                    <label for="categoryDescription" class="form-label">Description (Optional)</label>
                    <textarea class="form-control" id="categoryDescription" name="description" rows="3"></textarea>
                    <div class="form-text">Add details about this category to help customers understand what items they'll find here.</div>
                </div>
                
                <div class="mb-3">
                    <label for="categoryOrder" class="form-label">Display Order</label>
                    <input type="number" class="form-control" id="categoryOrder" name="order" value="0" min="0">
                    <div class="form-text">Lower numbers appear first. Categories with the same order value are sorted alphabetically.</div>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="categoryIsActive" name="is_active" checked>
                    <label class="form-check-label" for="categoryIsActive">
                        Category is active
                    </label>
                    <div class="form-text">Inactive categories won't be shown to customers.</div>
                </div>
                
                <div id="form-errors" class="alert alert-danger d-none mb-3"></div>
                
                <div class="d-flex justify-content-between">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Category
                    </button>
                    <a href="{% url 'webapp:menu_management' %}" class="btn btn-outline-secondary">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categoryForm = document.getElementById('category-form');
    const categoryIdInput = document.getElementById('categoryId');
    const categoryNameInput = document.getElementById('categoryName');
    const categoryDescriptionInput = document.getElementById('categoryDescription');
    const categoryOrderInput = document.getElementById('categoryOrder');
    const categoryIsActiveInput = document.getElementById('categoryIsActive');
    const formErrorsEl = document.getElementById('form-errors');
    
    const accessToken = localStorage.getItem('accessToken');
    const isEditMode = categoryIdInput.value !== '' && categoryIdInput.value !== 'None';
    let myRestaurantId = null;

    if (!accessToken) {
        window.location.href = "{% url 'webapp:login' %}?next=" + window.location.pathname;
        return;
    }

    function fetchAPI(endpoint, method = 'GET', body = null) {
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
        };
        const config = { method: method, headers: headers };
        if (body) config.body = JSON.stringify(body);
        
        return fetch(endpoint, config).then(response => {
            if (!response.ok) return response.json().then(err => { throw err; });
            return response.status === 204 ? null : response.json();
        });
    }

    // Get Restaurant ID first
    fetchAPI('/api/restaurants/list/mine/')
        .then(restaurantData => {
            if (restaurantData && restaurantData.id) {
                myRestaurantId = restaurantData.id;
                if (isEditMode) {
                    loadCategoryData(categoryIdInput.value);
                }
            } else {
                throw new Error("Could not identify your restaurant.");
            }
        })
        .catch(error => {
            console.error("Error fetching restaurant ID:", error);
            showError("Could not verify your restaurant. Please try again. " + (error.detail || error.message));
            categoryForm.innerHTML = '<p class="text-danger">Cannot load form.</p>';
        });

    function showError(message) {
        formErrorsEl.textContent = message;
        formErrorsEl.classList.remove('d-none');
    }

    function hideError() {
        formErrorsEl.textContent = '';
        formErrorsEl.classList.add('d-none');
    }

    function loadCategoryData(categoryId) {
        fetchAPI(`/api/categories/${categoryId}/`)
            .then(data => {
                categoryNameInput.value = data.name || '';
                categoryDescriptionInput.value = data.description || '';
                categoryOrderInput.value = data.order !== undefined ? data.order : 0;
                categoryIsActiveInput.checked = data.is_active !== undefined ? data.is_active : true;
                
                // Ensure restaurant ID matches
                if (data.restaurant !== myRestaurantId) {
                    showError("Error: This category does not belong to your restaurant.");
                    setTimeout(() => {
                        window.location.href = "{% url 'webapp:menu_management' %}";
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error loading category data:', error);
                showError('Failed to load category data. ' + (error.detail || JSON.stringify(error)));
            });
    }

    categoryForm.addEventListener('submit', function(event) {
        event.preventDefault();
        hideError();
        
        // Form validation
        if (!categoryForm.checkValidity()) {
            event.stopPropagation();
            categoryForm.classList.add('was-validated');
            return;
        }
        
        if (!myRestaurantId) {
            showError("Your restaurant information is not available. Cannot save category.");
            return;
        }

        const categoryData = {
            name: categoryNameInput.value.trim(),
            description: categoryDescriptionInput.value.trim(),
            order: parseInt(categoryOrderInput.value) || 0,
            is_active: categoryIsActiveInput.checked,
            restaurant: myRestaurantId
        };

        let url = '/api/categories/';
        let method = 'POST';

        if (isEditMode) {
            url += `${categoryIdInput.value}/`;
            method = 'PUT';
        }

        fetchAPI(url, method, categoryData)
            .then(data => {
                window.location.href = "{% url 'webapp:menu_management' %}?success=" + encodeURIComponent(`Category ${isEditMode ? 'updated' : 'created'} successfully!`);
            })
            .catch(error => {
                console.error(`Error ${isEditMode ? 'updating' : 'creating'} category:`, error);
                let errorMessage = '';
                
                if (typeof error === 'object' && error !== null) {
                    for (const key in error) {
                        const fieldName = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
                        const errorText = Array.isArray(error[key]) ? error[key].join(', ') : error[key];
                        errorMessage += `${fieldName}: ${errorText}\n`;
                    }
                } else {
                    errorMessage = error.toString();
                }
                
                showError(errorMessage.trim());
            });
    });
});
</script>
{% endblock %}